<?php
require_once ASCMS_CORE_MODULE_PATH.'/upload/lib/uploader.class.php';
/**
 * FormUploader - Class for upload via HTML input-tags.
 */
class FormUploader extends Uploader
{
    /**
     * @override
     */     
    public function handleRequest()
    {
        global $sessionObj;
        global $_FILES;

        //get a writable directory
        $targetDir = $sessionObj->getTempPath().'/upload_'.$this->uploadId;
        @mkdir($targetDir);
        
        //move all uploaded file to this upload's temp directory
        foreach($_FILES["uploaderFiles"]["error"] as $key => $error) {
            if($error == UPLOAD_ERR_OK) {
                $tmpName = $_FILES["uploaderFiles"]["tmp_name"][$key];
                $name = $_FILES["uploaderFiles"]["name"][$key];
                @move_uploaded_file($tmpName,$targetDir.'/'.$name);
            }
        }

        //and call back.
        $this->notifyCallback();
    }

    /**
     * @override
     */     
    public function getXHtml($backend = false)
    {
      //JS / CSS dependencies
      JS::activate('jquery');
      JS::registerCSS('core_modules/upload/css/uploaders/form/formUploader.css');
      JS::registerJS('core_modules/upload/js/uploaders/form/formUploader.js');

      $uploadPath = ($backend ? ASCMS_ADMIN_WEB_PATH : ASCMS_PATH_OFFSET).'/index.php?cmd=upload&act=upload&uploadType=form&uploadId='.$this->uploadId;

      $tpl = new HTML_Template_Sigma(ASCMS_CORE_MODULE_PATH.'/upload/template/uploaders');
      $tpl->setErrorHandling(PEAR_ERROR_DIE);
      
      $tpl->loadTemplateFile('form.html');
      $tpl->setVariable('UPLOAD_URL', $uploadPath);
      
      return $tpl->get();
    }
}