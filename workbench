#/bin/bash

###############################
# Contrexx Workbench install  #
# and wrapper script for UNIX #
#                             #
# (c) 2013 by Comvation AG    #
###############################

DOWNLOAD_URL="http://dev.contrexx.com/files/current/"
FILENAME="workbench-%s.tar.gz"

if [ "$1" != "" ] && [ -d "$1" ]; then
    INSTALLATION_PATH="$1"
    COMMANDLINE_ARGS=${@:2}
else
    INSTALLATION_PATH=`dirname $(readlink -f $0)`
    COMMANDLINE_ARGS=$@
fi

if [ ! -f "$INSTALLATION_PATH/config/settings.php" ]; then
    echo "$INSTALLATION_PATH is not a Contrexx installation directory"
    exit
fi

CONTREXX_VERSION=`grep "'coreCmsVersion'" /var/www/trunk/config/settings.php | awk '{print substr($3, 2, index($3,";")-3)}'`
FILENAME=`printf "$FILENAME" $CONTREXX_VERSION`

PHP_PATH="php"
while ! command -v "$PHP_PATH" &> /dev/null
do
    read -p "PHP could not be found, please enter the correct path to php or leave empty to abort: " path
    if [ "$path" == "" ]; then
        exit
    fi
    PHP_PATH=$path
done

if [ -f "$INSTALLATION_PATH/workbench.config" ]; then
    # workbench is installed
    php "$INSTALLATION_PATH/core_modules/Workbench/console.php" $COMMANDLINE_ARGS
else
    read -p "This will install the current version of the Contrexx Workbench into the following path ($INSTALLATION_PATH). Are you sure? [Y,n] " answer
    if [ "$answer" == "n" ]; then
        exit
    fi

    echo "Downloading workbench:"
    wget "$DOWNLOAD_URL$FILENAME"

    if [ ! -f "./$FILENAME" ]; then
        echo "Download failed, aborting."
        exit
    fi

    echo "Installing:"
    tar -zxvf "$FILENAME"
    echo "php=$PHP_PATH" > "$INSTALLATION_PATH/workbench.config"
fi
